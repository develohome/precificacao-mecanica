<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Or√ßamento Mec√¢nica</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

</head>
<body class="bg-light">

<div class="container py-3">

<h4 class="text-center mb-3">üì± Or√ßamento Mec√¢nica</h4>

<div class="card p-3 mb-3">
    <input id="oficina" class="form-control mb-2" value="Minha Oficina" placeholder="Nome da oficina">
    <input id="cliente" class="form-control mb-2" placeholder="Nome do cliente">
    <input id="veiculo" class="form-control mb-2" placeholder="Modelo do ve√≠culo">
</div>

<div class="card p-3 mb-3">
    <select id="servico" class="form-select mb-2">
        <option>Troca de √≥leo</option>
        <option>Alinhamento</option>
        <option>Balanceamento</option>
        <option>Troca de freios</option>
        <option>Suspens√£o</option>
        <option>Embreagem</option>
        <option>Revis√£o geral</option>
        <option>Diagn√≥stico eletr√¥nico</option>
    </select>

    <input id="mao" type="number" class="form-control mb-2" placeholder="M√£o de obra (R$)">
    <input id="peca" type="number" class="form-control mb-2" placeholder="Pe√ßa (R$)">

    <button class="btn btn-primary w-100" onclick="adicionar()">Adicionar servi√ßo</button>
</div>

<div class="table-responsive mb-3">
<table class="table table-bordered" id="tabela">
<thead class="table-dark">
<tr>
<th>Servi√ßo</th>
<th>M√£o</th>
<th>Pe√ßa</th>
<th>Total</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div class="card p-3 mb-3">
<input id="desconto" type="number" class="form-control mb-2" placeholder="Desconto (%)">
<button class="btn btn-success w-100" onclick="calcular()">Calcular total</button>
</div>

<div id="resultado" class="alert alert-info text-center"></div>

<button class="btn btn-danger w-100" onclick="gerarPDF()">üìÑ Gerar PDF</button>

</div>

<script>
let totalGeral = 0;

function adicionar(){
    let servico = document.getElementById("servico").value;
    let mao = parseFloat(document.getElementById("mao").value || 0);
    let peca = parseFloat(document.getElementById("peca").value || 0);
    let total = mao + peca;

    totalGeral += total;

    let linha = `
        <tr>
            <td>${servico}</td>
            <td>${mao.toFixed(2)}</td>
            <td>${peca.toFixed(2)}</td>
            <td>${total.toFixed(2)}</td>
        </tr>
    `;

    document.querySelector("#tabela tbody").innerHTML += linha;

    document.getElementById("mao").value = "";
    document.getElementById("peca").value = "";
}

function calcular(){
    let desconto = parseFloat(document.getElementById("desconto").value || 0);
    let valorDesconto = totalGeral * (desconto/100);
    let final = totalGeral - valorDesconto;

    document.getElementById("resultado").innerText =
        "Total bruto: R$ " + totalGeral.toFixed(2) + "\n" +
        "Desconto: " + desconto + "%\n" +
        "Total final: R$ " + final.toFixed(2);
}

function gerarPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    let agora = new Date();
    let data = agora.toLocaleDateString("pt-BR");
    let hora = agora.toLocaleTimeString("pt-BR");

    let oficina = document.getElementById("oficina").value;
    let cliente = document.getElementById("cliente").value;
    let veiculo = document.getElementById("veiculo").value;

    // CABE√áALHO
    doc.setFontSize(16);
    doc.text(oficina.toUpperCase(), 105, 10, {align:"center"});
    doc.setFontSize(12);
    doc.text("OR√áAMENTO", 105, 18, {align:"center"});

    // TABELA DADOS
    doc.autoTable({
        startY: 25,
        head:[["Campo","Informa√ß√£o"]],
        body:[
            ["Cliente",cliente],
            ["Ve√≠culo",veiculo]
        ]
    });

    // SERVI√áOS
    let dados = [];
    document.querySelectorAll("#tabela tbody tr").forEach(tr=>{
        let td = tr.querySelectorAll("td");
        dados.push([td[0].innerText,"R$ "+td[1].innerText,"R$ "+td[2].innerText,"R$ "+td[3].innerText]);
    });

    doc.autoTable({
        startY: doc.lastAutoTable.finalY + 10,
        head:[["Servi√ßo","M√£o de obra","Pe√ßa","Total"]],
        body:dados
    });

    // RESUMO
    let texto = document.getElementById("resultado").innerText.split("\n");
    let resumo = [
        ["Total bruto", texto[0].replace("Total bruto: ","")],
        ["Desconto", texto[1].replace("Desconto: ","")],
        ["Total final", texto[2].replace("Total final: ","")]
    ];

    doc.autoTable({
        startY: doc.lastAutoTable.finalY + 10,
        head:[["Resumo","Valor"]],
        body:resumo
    });

    // RODAP√â
    let h = doc.internal.pageSize.height;
    doc.setFontSize(10);
    doc.text("Gerado em: "+data+" √†s "+hora, 14, h-10);

    doc.save("orcamento.pdf");
}
</script>

</body>
</html>
